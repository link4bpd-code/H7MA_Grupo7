# This workflow builds your Arduino sketch and creates a public release
# with the compiled .bin file.

name: Build and Release Firmware

on:

  push:
    branches:
      - 'main'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    # This permission is required for the action to create a GitHub Release
    permissions:
      contents: write

    steps:
      # 1. Check out your code
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. Set up the Arduino CLI (Command Line Interface)
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      # 3. Update the board index
      - name: Update Core Index
        run: arduino-cli core update-index

      # 4. Install the board platform (e.g., esp32, arduino:avr)
      # ---!!! IMPORTANT: CHANGE THIS FOR YOUR BOARD !!!---
      # Example for ESP32:
      # - name: Install ESP32 Core
      #   run: arduino-cli core install esp32:esp32
      # Example for Arduino Uno (AVR):
      # - name: Install AVR Core
      #   run: arduino-cli core install arduino:avr
      - name: Install Cores
        run: |
          arduino-cli core update-index
          arduino-cli core install arduino:avr
          arduino-cli core install esp32:esp32

      # 5. Install any libraries you need
      # (Uncomment and modify this section if your sketch has dependencies)
      # - name: Install Libraries
      #   run: |
      #     arduino-cli lib install "WiFi"
      #     arduino-cli lib install "ArduinoJson"

      # 6. Compile the sketch
      # ---!!! IMPORTANT: CHANGE THESE VALUES !!!---
      # --fqbn: Your Fully Qualified Board Name.
      # ./MySketch: The path to your sketch (the folder containing your .ino file)
      - name: Find and Compile All Sketches
        run: |
          # --- Define your target platforms ---
          FQBN_AVR="arduino:avr:uno" # Example FQBN for AVR (e.g., Uno)
          FQBN_ESP32="esp32:esp32:esp32" # Your FQBN for ESP32

          echo "Finding .ino files (excluding blink.ino)..."

          # Find all .ino files, excluding blink.ino.
          # The 'while read' loop is safer for file paths with spaces.
          # find . -name "*.ino" -not -name "blink.ino" | while read -r sketch_file; do
          find . -name "*.ino" | while read -r sketch_file; do

            echo "--- Processing sketch: $sketch_file ---"

            # Get the .ino filename WITHOUT the .ino extension
            # e.g., "./subfolder/MySketch.ino" -> "MySketch"
            SKETCH_NAME=$(basename "$sketch_file" .ino)
            
            # --- 1. AVR Compilation (with directory fix) ---
            echo "Preparing $SKETCH_NAME for $FQBN_AVR..."

            # Create the required directory structure
            # e.g., ./temp_avr_sketches/MySketch
            TEMP_SKETCH_DIR="./temp_avr_sketches/$SKETCH_NAME"
            mkdir -p "$TEMP_SKETCH_DIR"
            
            # Copy the .ino file into it, renaming it to match the folder
            # e.g., cp ./subfolder/MySketch.ino ./temp_avr_sketches/MySketch/MySketch.ino
            cp "$sketch_file" "$TEMP_SKETCH_DIR/$SKETCH_NAME.ino"
            
            # Compile by pointing to the new temporary directory
            echo "Compiling $TEMP_SKETCH_DIR for $FQBN_AVR..."
            arduino-cli compile \
              --fqbn $FQBN_AVR \
              --output-dir ./build \
              "$TEMP_SKETCH_DIR" # <-- Point to the folder, not the file

            # --- 2. ESP32 Compilation (unmodified) ---
            # This assumes the ESP32 compiler is fine with the original file path
            echo "Compiling $sketch_file for $FQBN_ESP32..."
            arduino-cli compile \
              --fqbn $FQBN_ESP32 \
              --output-dir ./build \
              "$TEMP_SKETCH_DIR" # <-- Point to the original file
              
          done
          
      - name: Clean up temp sketches
        if: always() # Run even if compilation fails
        run: rm -rf ./temp_avr_sketches
        
      # 7. Create or Update the "latest" Release
      # This step uses the GitHub CLI (gh) which is pre-installed.
      # It tries to create a release. If it fails (because "latest" exists),
      # it deletes and re-creates it, ensuring the "latest" tag
      # always points to the newest commit on 'main'.
      - name: Create or Update "latest" Release
        env:
          # The GITHUB_TOKEN is automatically provided by Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Try to create the release. This will tag the current commit as "latest"
          # If it fails (because "latest" tag/release already exists), it will exit with an error.
          gh release create latest \
            --title "Latest Build (main)" \
            --notes "Automatic build from the main branch." \
            --latest \
            --prerelease=false \
            --draft=false \
            ./build/*.bin ./build/*.hex \
          || \
          ( \
            echo "Release 'latest' already exists. Re-creating..." && \
            # Delete the existing release. This also deletes the "latest" tag.
            gh release delete latest -y && \
            # Re-create the release, which will tag the current commit as "latest"
            gh release create latest \
              --title "Latest Build (main)" \
              --notes "Automatic build from the main branch." \
              --latest \
              --prerelease=false \
              --draft=false \
              ./build/*.bin ./build/*.hex \
          )
